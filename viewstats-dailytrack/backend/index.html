<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Channel Analytics Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { background: #f4f6f9; font-family: Arial, sans-serif; }
    .container { margin-top: 30px; }
    .card { margin-top: 20px; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #007bff; color: #fff; }
    button { margin-top: 15px; }
</style>
</head>
<body>
<div class="container">
    <h2 class="text-center">YouTube Channel Analytics Dashboard</h2>

    <div class="card">
        <div class="row g-3">
            <div class="col-md-5">
                <input type="text" id="channelUrl" class="form-control" placeholder="Enter YouTube Channel URL">
            </div>
            <div class="col-md-3">
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-3">
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary" id="searchBtn">Search</button>
            </div>
        </div>
    </div>

    <div class="card">
        <canvas id="viewsChart" height="150"></canvas>
        <canvas id="likesChart" height="150"></canvas>
        <canvas id="commentsChart" height="150"></canvas>
    </div>

    <div class="card">
        <button id="exportBtn" class="btn btn-success">Export to Excel</button>
        <table id="videoTable">
            <thead>
                <tr>
                    <th>Video ID</th>
                    <th>Title</th>
                    <th>Published</th>
                    <th>Views</th>
                    <th>Likes</th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const apiBase = "https://youtube-dashboard-4lst.onrender.com"; // Hosted backend URL

const viewsChart = new Chart(document.getElementById('viewsChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Views', data: [], borderColor: '#007bff', fill: false }] }, options: { responsive: true }});
const likesChart = new Chart(document.getElementById('likesChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Likes', data: [], borderColor: '#28a745', fill: false }] }, options: { responsive: true }});
const commentsChart = new Chart(document.getElementById('commentsChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Comments', data: [], borderColor: '#dc3545', fill: false }] }, options: { responsive: true }});

document.getElementById('searchBtn').addEventListener('click', async () => {
    const url = document.getElementById('channelUrl').value.trim();
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    if (!url || !start || !end) { alert("Enter all fields"); return; }

    try {
        const res = await fetch(`${apiBase}/channel-stats?url=${encodeURIComponent(url)}&start=${start}&end=${end}`);
        if (!res.ok) { alert("Failed to fetch data"); return; }
        const data = await res.json();
        if (!data.videos || data.videos.length === 0) { alert("No videos found"); return; }

        const tbody = document.querySelector('#videoTable tbody');
        tbody.innerHTML = '';
        data.videos.forEach(v => {
            const row = `<tr>
                <td>${v.video_id}</td>
                <td>${v.title}</td>
                <td>${v.published.split('T')[0]}</td>
                <td>${v.today.views}</td>
                <td>${v.today.likes}</td>
                <td>${v.today.comments}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        // Prepare chart data
        const labels = data.videos.map(v => v.title.substring(0, 15)+'...');
        viewsChart.data.labels = labels;
        viewsChart.data.datasets[0].data = data.videos.map(v => v.today.views);
        viewsChart.update();

        likesChart.data.labels = labels;
        likesChart.data.datasets[0].data = data.videos.map(v => v.today.likes);
        likesChart.update();

        commentsChart.data.labels = labels;
        commentsChart.data.datasets[0].data = data.videos.map(v => v.today.comments);
        commentsChart.update();

    } catch (err) {
        console.error(err);
        alert("Error fetching data from server.");
    }
});

// Export table to Excel
document.getElementById('exportBtn').addEventListener('click', () => {
    const table = document.getElementById('videoTable');
    const wb = XLSX.utils.table_to_book(table, { sheet: "Videos" });
    XLSX.writeFile(wb, "youtube_channel_data.xlsx");
});
</script>
</body>
</html>
